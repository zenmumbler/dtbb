!function(){"use strict";function e(e,t){var n,r,o=new Set;return e.size<t.size?(s=[e,t],n=s[0],r=s[1]):(i=[t,e],n=i[0],r=i[1]),n.forEach(function(e){r.has(e)&&o.add(e)}),o;var s,i}function t(e,t){t.forEach(function(t){return e.add(t)})}function n(e){for(var t=new Set,n=e.length,r=0;r<n;++r)t.add(e[r]);return t}function r(e){for(var t={},n=0,r=0,o=e;r<o.length;r++){var s=o[r];t[s.key]={key:s.key,label:s.label,mask:1<<n},n+=1}return t}function o(e){return e.reduce(function(e,t){var n=x[t];return e|(n?n.mask:0)},0)}function s(e){return new Promise(function(t,n){var r=new XMLHttpRequest;r.open("GET",e),r.overrideMimeType("application/json"),r.responseType="json",r.onload=function(){t(r.response)},r.onerror=n,r.send(null)})}function i(e,t){return e<<16|t}var a=function(){function e(e,t,n){this.db_=this.request(indexedDB.open(e,t),function(e){e.onupgradeneeded=function(r){var o=e.result;n(o,r.oldVersion,r.newVersion||t)}}).catch(function(t){console.warn("Failed to open / upgrade database '"+e+"'",t)}),this.tctx_={request:this.request.bind(this),cursor:this.cursor.bind(this),keyCursor:this.keyCursor.bind(this),getAll:this.getAll.bind(this),getAllKeys:this.getAllKeys.bind(this)}}return e.prototype.close=function(){this.db_.then(function(e){e.close()})},e.prototype.transaction=function(e,t,n){var r=this;return this.db_.then(function(o){return new Promise(function(s,i){var a=o.transaction(e,t);a.onerror=function(){i(a.error||"transaction failed")},a.onabort=function(){i("aborted")};var u=n(a,r.tctx_);a.oncomplete=function(){s(void 0===u?void 0:u)}})})},e.prototype.request=function(e,t){var n=new Promise(function(n,r){e.onerror=function(){r(e.error||"request failed")},e.onsuccess=function(){n(e.result)},t&&t(e)});return this.db_?this.db_.then(function(){return n}):n},e.prototype.cursorImpl=function(e){var t={next:function(e){return this.callbackFn_=e,this},complete:function(e){return this.completeFn_=e,this},catch:function(e){return this.errorFn_=e,this}};return e.onerror=function(){t.errorFn_&&t.errorFn_(e.error)},e.onsuccess=function(){var n=e.result;n?t.callbackFn_&&t.callbackFn_(n):t.completeFn_&&t.completeFn_()},t},e.prototype.cursor=function(e,t,n){var r=e.openCursor(t,n);return this.cursorImpl(r)},e.prototype.keyCursor=function(e,t,n){var r=e.openKeyCursor(t,n);return this.cursorImpl(r)},e.prototype.getAll=function(e,t,n,r){var o=this;return new Promise(function(s,i){var a=[];o.cursor(e,t,n).next(function(e){a.push(e.value),r&&a.length===r?s(a):e.continue()}).complete(function(){s(a)}).catch(function(e){i(e)})})},e.prototype.getAllKeys=function(e,t,n,r){var o=this;return new Promise(function(s,i){var a=[];o.keyCursor(e,t,n).next(function(e){a.push(e.key),r&&a.length===r?s(a):e.continue()}).complete(function(){s(a)}).catch(function(e){i(e)})})},e}(),u=function(){function e(){this.db_=new a("dtbb",1,function(e,t,n){console.info("Creating stores and indexes...");var r=e.createObjectStore("headers",{keyPath:"issue"}),o=e.createObjectStore("textindexes",{keyPath:"issue"}),s=e.createObjectStore("entries",{keyPath:"docID"});r.createIndex("issue","issue",{unique:!0}),o.createIndex("issue","issue",{unique:!0}),s.createIndex("issue","ld_issue"),s.createIndex("category","category"),s.createIndex("platform","platforms",{multiEntry:!0})})}return e.prototype.saveCatalog=function(e,t,n){var r={issue:e.issue,theme:e.theme,stats:e.stats,savedAt:new Date};return this.db_.transaction(["headers","entries","textindexes"],"readwrite",function(o,s){var i=s.request;console.info("Storing issue "+r.issue+" with "+t.length+" entries and textindex");var a=o.objectStore("headers"),u=o.objectStore("entries"),c=o.objectStore("textindexes");i(a.put(r));var d={issue:e.issue,data:n};i(c.put(d));for(var l=0,h=t;l<h.length;l++){var f=h[l];i(u.put(f))}}).catch(function(t){throw console.warn("Error saving catalog "+e.issue,t),t})},e.prototype.saveCatalogTextIndex=function(e,t){var n={issue:e,data:t};return this.db_.transaction("textindexes","readwrite",function(e,t){var r=t.request,o=e.objectStore("textindexes");r(o.put(n))}).catch(function(e){throw console.warn("Error saving textindex: ",e),e})},e.prototype.persistedIssues=function(){return this.db_.transaction("headers","readonly",function(e,t){var n=t.getAllKeys,r=e.objectStore("headers").index("issue");return n(r,void 0,"nextunique")}).catch(function(){return[]})},e.prototype.loadCatalog=function(e){return this.db_.transaction(["headers","entries","textindexes"],"readonly",function(t,n){var r=n.request,o=n.getAll,s=r(t.objectStore("headers").get(e)),i=t.objectStore("entries").index("issue"),a=o(i,e),u=r(t.objectStore("textindexes").get(e));return Promise.all([s,a,u]).then(function(e){var t=e[2];return{header:e[0],entries:e[1],sti:t&&t.data}})}).catch(function(){return null})},e.prototype.destroyCatalog=function(e){return this.db_.transaction(["headers","entries","textindexes"],"readwrite",function(t,n){var r=n.request,o=n.getAllKeys,s=t.objectStore("headers"),i=t.objectStore("entries"),a=i.index("issue"),u=t.objectStore("textindexes");o(a,e).then(function(e){for(var t=0,n=e;t<n.length;t++){var o=n[t];r(i.delete(o))}}),r(s.delete(e)),r(u.delete(e))})},e.prototype.purgeAll=function(){var e=this;return this.persistedIssues().then(function(t){return Promise.all(t.map(function(t){return e.destroyCatalog(t)}))})},e}(),c={"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","Ç":"C","È":"E","É":"E","Ê":"E","Ë":"E","Ì":"I","Í":"I","Î":"I","Ï":"I","Ñ":"N","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ø":"O","Ù":"U","Ú":"U","Û":"U","Ü":"U","Ý":"Y","ß":"ss","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","ç":"c","è":"e","é":"e","ê":"e","ë":"e","ì":"i","í":"i","î":"i","ï":"i","ñ":"n","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ø":"o","ù":"u","ú":"u","û":"u","ü":"u","ý":"y","ÿ":"y"},d=/[^a-zA-Z0-9ÀÁÂÃÄÅÇÈÉÊËÌÍÎÏÑÒÓÔÕÖØÙÚÛÜÝßàáâãäåçèéêëìíîïñòóôõöøùúûüýÿ]/g,l=/[ÀÁÂÃÄÅÇÈÉÊËÌÍÎÏÑÒÓÔÕÖØÙÚÛÜÝßàáâãäåçèéêëìíîïñòóôõöøùúûüýÿ]/,h={};Object.keys(c).forEach(function(e){return h[e]=new RegExp(e,"g")});var f,p=function(){function r(){this.data_=new Map,this.wordNGramCache_=new Map,this.MIN_NGRAM_LENGTH=2,this.MAX_NGRAM_LENGTH=12,this.collapsedPunctuationMatcher=/['-]/g,this.multipleSpacesMatcher=/ +/g}return r.prototype.export=function(){var e={};return this.data_.forEach(function(t,n){var r=[];t.forEach(function(e){return r.push(e)}),e[n]=r}),e},r.prototype.import=function(e){var o=this;if(e instanceof r)e.data_.forEach(function(e,n){o.data_.has(n)?t(o.data_.get(n),e):o.data_.set(n,e)});else for(var s in e)this.data_.has(s)?t(this.data_.get(s),e[s]):this.data_.set(s,n(e[s]))},Object.defineProperty(r.prototype,"ngramCount",{get:function(){return this.data_.size},enumerable:!0,configurable:!0}),r.prototype.wordNGrams=function(e){if(this.wordNGramCache_.has(e))return this.wordNGramCache_.get(e);for(var t=e.length,n=new Set,r=this.MIN_NGRAM_LENGTH;r<=this.MAX_NGRAM_LENGTH&&!(r>t);++r)for(var o=t-r,s=0;s<=o;++s){var i=e.substr(s,r);n.has(i)||n.add(i)}return this.wordNGramCache_.set(e,n),n},r.prototype.stripDiacritics=function(e){for(var t;t=e.match(l);){var n=e[t.index];e=e.replace(h[n],c[n])}return e},r.prototype.tokenizeString=function(e){var t=e.toLowerCase().replace(this.collapsedPunctuationMatcher,"").replace(d," ").replace(this.multipleSpacesMatcher," ").trim(),r=t.split(" ");return n(r)},r.prototype.indexRawString=function(e,t){var r=this,o=[t],s=this.tokenizeString(e);s.forEach(function(e){e=r.stripDiacritics(e);var s=r.wordNGrams(e);s.forEach(function(e){r.data_.has(e)?r.data_.get(e).add(t):r.data_.set(e,n(o))})})},r.prototype.query=function(t){var n=this,r=this.tokenizeString(t),o=[],s=!1;if(r.forEach(function(e){e.length<n.MIN_NGRAM_LENGTH||(e.length>n.MAX_NGRAM_LENGTH&&(e=e.substr(0,n.MAX_NGRAM_LENGTH)),e=n.stripDiacritics(e),n.data_.has(e)?o.push(n.data_.get(e)):s=!0)}),s)return new Set;if(0==o.length)return null;o.sort(function(e,t){return e.size<t.size?-1:1});for(var i=new Set(o[0]),a=1;a<o.length;++a)i=e(i,o[a]);return i},r}(),x=r([{key:"desktop",label:"Desktop"},{key:"win",label:"Windows"},{key:"mac",label:"MacOS"},{key:"linux",label:"Linux"},{key:"web",label:"Web"},{key:"java",label:"Java"},{key:"vr",label:"VR"},{key:"mobile",label:"Mobile"}]),v=function(){function e(){var e=this;this.promFuncs_=new Map,this.nextIndex_=0,this.worker_=new Worker("task_indexer.js"),this.worker_.onerror=function(e){console.warn("An internal error occurred inside the indexer task: "+e.error+" @ "+e.lineno+":"+e.colno)},this.worker_.onmessage=function(t){var n=t.data;if(n&&"string"==typeof n.status&&"number"==typeof n.reqIndex){var r=e.promFuncs_.get(n.reqIndex);r?"status"===n.status?r.progress&&r.progress(n.progress):("success"===n.status?r.resolve(n):"error"===n.status&&r.reject(n),e.promFuncs_.delete(n.reqIndex)):console.warn("IndexerAPI: Cannot find the functions for request #"+n.reqIndex)}else console.warn("IndexerAPI: Got an invalid response from the server: "+n)}}return e.prototype.promisedCall=function(e,t){var n=this;return new Promise(function(r,o){n.promFuncs_.set(e.reqIndex,{resolve:r,reject:o,progress:t}),n.worker_.postMessage(e)})},e.prototype.open=function(){this.nextIndex_+=1;var e={what:"open",reqIndex:this.nextIndex_};return this.promisedCall(e)},e.prototype.index=function(e,t){this.nextIndex_+=1;var n={what:"index",reqIndex:this.nextIndex_,issue:e};return this.promisedCall(n,t)},e}(),g=function(){function e(e,t){var n=this;this.persist_=e,"worker"===t&&(this.api_=new v,this.api_.open().catch(function(){console.warn("Got a failure when trying to connect to Indexer API, disabling"),n.api_=void 0}))}return e.prototype.acceptCatalogData=function(e){for(var t=e.entries.map(function(e){var t=e;return t.indexes={platformMask:0},t}),n=t.length,r=new p,s=0;s<n;++s){var a=t[s],u=i(e.issue,s);a.docID=u,a.indexes.platformMask=o(a.platforms),r.indexRawString(a.title,u),r.indexRawString(a.author.name,u),r.indexRawString(a.description,u);for(var c=0,d=a.links;c<d.length;c++){var l=d[c];r.indexRawString(l.label,u)}this.onProgress&&this.onProgress(s,n)}return this.storeCatalog(e,t,r),{entries:t,textIndex:r}},e.prototype.storeCatalog=function(e,t,n){this.persist_.saveCatalog(e,t,n.export()).then(function(){console.info("saved issue "+e.issue)})},e.prototype.importCatalogFile=function(e,t){var n=this;if(this.api_)return this.api_.index(e,t).then(function(e){var t=new p;return t.import(e.textIndex),{entries:e.entries,textIndex:t}});var r=1,o="zenmumbler.net"!==location.host.toLowerCase()?".json":".gzjson",i="data/ld"+e+"_entries"+o+"?"+r;return location.pathname.indexOf("/workers")>-1&&(i="../"+i),s(i).then(function(e){return n.acceptCatalogData(e)})},e}();self.onmessage=function(e){var t=e.data,n=function(e){postMessage({status:"error",reqIndex:t&&"reqIndex"in t?t.reqIndex:null,message:e})};if("object"==typeof t&&"what"in t)if("open"===t.what)void 0===f?(f=new u,postMessage({status:"success",reqIndex:t.reqIndex})):n("Redundant open request");else if("index"===t.what)if(void 0!==f)if("number"==typeof t.issue&&t.issue>=15&&t.issue<=40){var r=new g(f,"local");r.onProgress=function(e,n){e%100===0&&postMessage({status:"status",reqIndex:t.reqIndex,progress:e/n})},r.importCatalogFile(t.issue).then(function(e){postMessage({status:"success",reqIndex:t.reqIndex,entries:e.entries,textIndex:e.textIndex.export()})})}else n("Invalid issue number: "+t.issue);else n("Got an index request without active database.");else n("Unknown request type "+t.what);else n("Invalid request structure sent to worker: "+JSON.stringify(t))}}();